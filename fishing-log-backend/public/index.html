<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fishing Trip Logger</title>

    <!-- XLSX for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Leaflet CSS & JS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1100px;
            margin: auto;
            padding: 20px;
            background: #f5f7fb;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
        }

        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Cards */
        .card {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        /* Left = form, right = map */
        .form-card {
            flex: 1 1 360px;
        }

        .map-card {
            flex: 1 1 360px;
        }

        /* Form styling */
        form label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccd1e4;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 10px;
            border: none;
            background: #007bff;
            color: white;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .secondary-btn {
            background: #6c757d;
        }

        .secondary-btn:hover {
            background: #545b62;
        }

        .action-btn {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }

        .action-btn:hover {
            background: #a71d2a;
        }

        /* Map */
        #map {
            width: 100%;
            height: 350px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .map-hint {
            font-size: 13px;
            color: #555;
            margin-top: 5px;
        }

        /* Table */
        .table-card {
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        table th,
        table td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 13px;
            text-align: left;
        }

        table th {
            background: #007bff;
            color: white;
        }

        @media (max-width: 800px) {
            .main-layout {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <h2>Fishing Trip Logger</h2>
    <div class="subtitle">
        Click on the map to set your spot, save it with a name, and reuse it for future trips.
    </div>

    <div class="main-layout">
        <!-- LEFT: FORM -->
        <div class="card form-card">
            <form id="manualForm">
                <label>Catch Status:
                    <select id="catch_status">
                        <option value="1">Catch</option>
                        <option value="2">No Catch</option>
                    </select>
                </label>

                <label>Title:
                    <input type="text" id="title" required />
                </label>

                <label>Date:
                    <input type="date" id="date" required />
                </label>

                <label>Time:
                    <input type="time" id="time" required />
                </label>

                <label>Saved Spot:
                    <select id="areaDropdown"></select>
                </label>

                <label>Area Name:
                    <input type="text" id="area" placeholder="E.g. JC Hole, Johnson Creek, etc." />
                </label>

                <label>Latitude:
                    <input type="text" id="latitude" placeholder="Click map or type" />
                </label>

                <label>Longitude:
                    <input type="text" id="longitude" placeholder="Click map or type" />
                </label>

                <label>Species:
                    <select id="species">
                        <option value="">Select</option>
                        <option value="Steelhead">Steelhead</option>
                        <option value="Chinook">Chinook</option>
                        <option value="Coho">Coho</option>
                        <option value="Rainbow Trout">Rainbow Trout</option>
                        <option value="Cutthroat Trout">Cutthroat Trout</option>
                        <option value="Sockeye">Sockeye</option>
                        <option value="Chum">Chum</option>
                        <option value="Pink">Pink</option>
                    </select>
                </label>

                <label>Technique:
                    <select id="technique">
                        <option value="">Select</option>
                        <option value="Float">Float</option>
                        <option value="Drift">Drift</option>
                        <option value="Plunk">Plunk</option>
                    </select>
                </label>

                <label>Hatchery / Wild:
                    <select id="hatcheryWild">
                        <option value="">Unknown</option>
                        <option value="Hatchery">Hatchery</option>
                        <option value="Wild">Wild</option>
                    </select>
                </label>

                <label>Weather Temp (¬∞F):
                    <input type="text" id="weatherTemp" />
                </label>

                <label>Weather Condition:
                    <select id="weatherCondition">
                        <option value="">Select</option>
                        <option value="Clear">Clear</option>
                        <option value="Partly Cloudy">Partly Cloudy</option>
                        <option value="Overcast">Overcast</option>
                    </select>
                </label>

                <label>Tide Stage: (auto from API)
                    <select id="tideStage">
                        <option value="">Select</option>
                        <option value="Rising">Rising</option>
                        <option value="Dropping">Falling</option>
                        <option value="Slack">Slack</option>
                    </select>
                </label>

                <div class="button-row">
                    <button type="button" class="secondary-btn" id="saveSpotBtn">
                        Save Spot
                    </button>
                    <button type="submit">
                        Add Entry
                    </button>
                </div>

                <div class="button-row">
                    <button type="button" onclick="exportToExcel()">
                        Download Excel
                    </button>
                </div>
            </form>
        </div>

        <!-- RIGHT: MAP -->
        <div class="card map-card">
            <label>Map Location</label>
            <div id="map"></div>
            <div class="map-hint">
                üó∫Ô∏è Click on the map to set latitude & longitude.
                Saved spots will auto-center the map and fill coordinates.
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card table-card">
        <table id="entryTable">
            <thead>
                <tr>
                    <th>Catch Status</th>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Area</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Species</th>
                    <th>Technique</th>
                    <th>Hatchery/Wild</th>
                    <th>Weather Temp</th>
                    <th>Weather Condition</th>
                    <th>Tide Stage</th>
                    <th>Tide Height (ft)</th>
                    <th>Tide Rate (ft/hr)</th>
                    <th>Baro Current (hPa)</th>
                    <th>Baro Prev 3h (hPa)</th>
                    <th>Baro Trend</th>
                    <th>Sunrise</th>
                    <th>Sunset</th>
                    <th>Moonrise</th>
                    <th>Moonset</th>
                    <th>Moon Phase</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody></tbody>
        </table>
    </div>

    <script>
        // ---------- State ----------
        const form = document.getElementById("manualForm");
        const tableBody = document.querySelector("#entryTable tbody");

        let entries = JSON.parse(localStorage.getItem("fishingEntries")) || [];
        let locationMap = JSON.parse(localStorage.getItem("locationMap")) || {};

        const areaDropdown = document.getElementById("areaDropdown");
        const areaInput = document.getElementById("area");
        const latInput = document.getElementById("latitude");
        const lonInput = document.getElementById("longitude");
        const saveSpotBtn = document.getElementById("saveSpotBtn");

        // ---------- Populate Saved Spots ----------
        function populateAreaDropdown() {
            areaDropdown.innerHTML = '<option value="">Select saved spot</option>';
            for (let name in locationMap) {
                areaDropdown.innerHTML += `<option value="${name}">${name}</option>`;
            }
        }
        populateAreaDropdown();

        // ---------- Map Setup ----------
        let map = L.map('map').setView([45.936159, -122.627983], 11); // JC-ish default

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let currentMarker = null;

        function setMapMarker(lat, lon) {
            const latNum = parseFloat(lat);
            const lonNum = parseFloat(lon);
            if (isNaN(latNum) || isNaN(lonNum)) return;

            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            currentMarker = L.marker([latNum, lonNum]).addTo(map);
            map.setView([latNum, lonNum], 13);
        }

        // Click on map sets coords + marker
        map.on('click', function (e) {
            const { lat, lng } = e.latlng;
            latInput.value = lat.toFixed(6);
            lonInput.value = lng.toFixed(6);
            setMapMarker(lat, lng);
        });

        // Change saved spot ‚Üí fill fields + move map
        areaDropdown.addEventListener("change", () => {
            const name = areaDropdown.value;
            const loc = locationMap[name];
            if (!loc) return;

            areaInput.value = name;
            latInput.value = loc.latitude;
            lonInput.value = loc.longitude;
            setMapMarker(loc.latitude, loc.longitude);
        });

        // Save current area + coords as a named spot
        saveSpotBtn.addEventListener("click", () => {
            const name = areaInput.value.trim();
            const lat = latInput.value.trim();
            const lon = lonInput.value.trim();

            if (!name || !lat || !lon) {
                alert("Please enter area name and set latitude & longitude (click map or type) before saving a spot.");
                return;
            }

            locationMap[name] = { latitude: lat, longitude: lon };
            localStorage.setItem("locationMap", JSON.stringify(locationMap));
            populateAreaDropdown();
            alert(`Saved spot "${name}"`);
        });

        // ---------- Load Saved Entries into Table ----------
        window.onload = function () {
            entries.forEach((entry, index) => addRow(entry, index));
        };

        // ---------- Form Submit ----------
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            const data = {
                catch_status: document.getElementById("catch_status").value,
                title: document.getElementById("title").value,
                date: document.getElementById("date").value,
                time: document.getElementById("time").value,
                area_name: areaInput.value,
                latitude: latInput.value,
                longitude: lonInput.value,
                species: document.getElementById("species").value,
                technique: document.getElementById("technique").value,
                hatchery_wild: document.getElementById("hatcheryWild").value,

                // Force backend to compute this
                weather_temp: null,
                weather_condition: null,

                tide_stage: null,
                tide_height_ft: null,
                tide_rate_ft_per_hr: null,
                barometric_current: null,
                barometric_prev3h: null,
                barometric_pressure_trend: null,
                sunrise: null,
                sunset: null,
                moonrise: null,
                moonset: null,
                moon_phase_name: null
            };


            // Save locally first
            entries.push(data);
            const thisIndex = entries.length - 1;
            addRow(data, thisIndex);
            localStorage.setItem("fishingEntries", JSON.stringify(entries));

            // Send to backend (server will enrich with astro + baro + tide)
            fetch("/log", {              // relative URL since frontend is served by same server
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    catch_status: data.catch_status,
                    title: data.title,
                    date: data.date,
                    time: data.time,
                    area_name: data.area_name,
                    latitude: data.latitude,
                    longitude: data.longitude,
                    species: data.species,
                    technique: data.technique,
                    hatchery_wild: data.hatchery_wild,
                    weather_temp: data.weather_temp,
                    weather_condition: data.weather_condition,
                    tide_stage: null,
                    moon_phase: null,
                    barometric_current: null,
                    barometric_prev3h: null,
                    tide_station_id_used: null
                })
            })
                .then(res => res.json())
                .then(response => {
                    console.log("Saved to DB:", response);

                    // ----- TIDE -----
                    if (response.tide) {
                        const t = response.tide;

                        entries[thisIndex].tide_stage = t.tide_stage || "";
                        entries[thisIndex].tide_height_ft =
                            t.tide_height_ft != null ? t.tide_height_ft.toFixed(3) : "";
                        entries[thisIndex].tide_rate_ft_per_hr =
                            t.tide_rate_ft_per_hr != null ? t.tide_rate_ft_per_hr.toFixed(3) : "";
                    }

                    // ----- BAROMETRIC -----
                    if (response.baro) {
                        const b = response.baro;
                        entries[thisIndex].barometric_current =
                            b.barometric_current != null ? b.barometric_current.toFixed(1) : "";
                        entries[thisIndex].barometric_prev3h =
                            b.barometric_prev3h != null ? b.barometric_prev3h.toFixed(1) : "";
                        entries[thisIndex].barometric_pressure_trend =
                            b.barometric_pressure_trend || "";
                    }

                    // ----- ASTRONOMY -----
                    if (response.astro) {
                        const a = response.astro;
                        entries[thisIndex].sunrise = a.sunrise || "";
                        entries[thisIndex].sunset = a.sunset || "";
                        entries[thisIndex].moonrise = a.moonrise || "";
                        entries[thisIndex].moonset = a.moonset || "";
                        entries[thisIndex].moon_phase_name = a.moon_phase_name || "";
                    }
                    // ----- WEATHER (from backend) -----
                    if (response.weather_temp !== undefined) {
                        entries[thisIndex].weather_temp = response.weather_temp;
                    }
                    if (response.weather_condition !== undefined) {
                        entries[thisIndex].weather_condition = response.weather_condition;
                    }



                    localStorage.setItem("fishingEntries", JSON.stringify(entries));
                    refreshTable(); // redraw table with updated info

                    form.reset();
                })
                .catch(err => {
                    console.error("DB error:", err);
                    form.reset();
                });
        });



        // ---------- Table Helpers ----------
        function addRow(data, index) {
            const row = document.createElement("tr");

            [
                data.catch_status,
                data.title,
                data.date,
                data.time,
                data.area_name,
                data.latitude,
                data.longitude,
                data.species,
                data.technique,
                data.hatchery_wild,
                data.weather_temp,
                data.weather_condition,
                data.tide_stage,
                data.tide_height_ft,
                data.tide_rate_ft_per_hr,
                data.barometric_current,
                data.barometric_prev3h,
                data.barometric_pressure_trend,
                data.sunrise,
                data.sunset,
                data.moonrise,
                data.moonset,
                data.moon_phase_name
            ].forEach(val => {
                const cell = document.createElement("td");
                cell.textContent = val == null ? "" : val;
                row.appendChild(cell);
            });

            const actionCell = document.createElement("td");
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.classList.add("action-btn");
            deleteBtn.onclick = function () { deleteEntry(index); };
            actionCell.appendChild(deleteBtn);
            row.appendChild(actionCell);

            tableBody.appendChild(row);
        }

        function deleteEntry(index) {
            entries.splice(index, 1);
            localStorage.setItem("fishingEntries", JSON.stringify(entries));
            refreshTable();
        }

        function refreshTable() {
            tableBody.innerHTML = "";
            entries.forEach((entry, index) => addRow(entry, index));
        }

        // ---------- Excel Export ----------
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(entries);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Fishing Log");
            XLSX.writeFile(wb, "fishing_log_manual.xlsx");
        }
    </script>

</body>

</html>