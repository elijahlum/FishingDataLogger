<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fishing Trip Logger</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}
button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>
<body>
<h1>Fishing Trip Logger</h1>

<label>Title: <input type="text" id="title"></label><br><br>
<label>Date: <input type="date" id="date"></label><br><br>
<label>Time: <input type="time" id="time"></label><br><br>
<label>Latitude: <input type="number" step="any" id="latitude"></label><br><br>
<label>Longitude: <input type="number" step="any" id="longitude"></label><br><br>
<label>Area Name: <input type="text" id="area"></label><br><br>

<button onclick="logTrip()">Log Trip</button>

<script>
const openWeatherApiKey = "cc3586d4c42cc1e784e39c79dd5fff72";

// ✅ Fetch weather data (with offline fallback)
async function fetchWeatherData(lat, lon) {
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${openWeatherApiKey}&units=imperial`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("Weather API failed");
    const data = await response.json();

    return {
      temp: data?.main?.temp ? data.main.temp.toFixed(2) + " °F" : "Unavailable",
      condition: data?.weather?.[0]?.description || "Unavailable"
    };
  } catch (error) {
    console.warn("Weather fetch failed:", error);
    return { temp: "Unavailable", condition: "Unavailable" };
  }
}

// ✅ Fetch NOAA barometric pressure (with fallback to OpenWeather)
async function fetchBarometricPressure(lat, lon) {
  const now = new Date();
  const endDate = now.toISOString();
  const startDate = new Date(now.getTime() - 6 * 60 * 60 * 1000).toISOString();

  const noaaUrl = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=air_pressure&application=FishingLogger&begin_date=${startDate}&end_date=${endDate}&datum=MSL&station=9439040&time_zone=gmt&units=metric&format=json`;

  try {
    const response = await fetch(noaaUrl);
    if (!response.ok) throw new Error("NOAA API failed");
    const data = await response.json();

    if (data && data.data && data.data.length > 0) {
      const current = data.data[data.data.length - 1].v + " hPa";
      const sixHoursAgo = data.data[0].v + " hPa";
      const trend = parseFloat(current) > parseFloat(sixHoursAgo) ? "Rising" : "Falling";
      return { current, sixHoursAgo, trend };
    } else {
      throw new Error("No NOAA data");
    }
  } catch (error) {
    console.warn("NOAA fetch failed, using fallback:", error);

    // ✅ Fallback to OpenWeather
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${openWeatherApiKey}&units=imperial`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("OpenWeather fallback failed");
      const data = await response.json();

      const pressure = data?.main?.pressure ? data.main.pressure + " hPa" : "Unavailable";
      return { current: pressure, sixHoursAgo: "Unavailable", trend: "Unavailable" };
    } catch (fallbackError) {
      console.warn("Fallback also failed:", fallbackError);
      return { current: "Unavailable", sixHoursAgo: "Unavailable", trend: "Unavailable" };
    }
  }
}

async function logTrip() {
  const title = document.getElementById("title").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const lat = parseFloat(document.getElementById("latitude").value);
  const lon = parseFloat(document.getElementById("longitude").value);
  const area = document.getElementById("area").value;

  console.log("Fetching data for trip...");

  // ✅ Always try to get data, but don't break if something fails
  const weather = await fetchWeatherData(lat, lon);
  const barometric = await fetchBarometricPressure(lat, lon);

  // ✅ Create row for Excel
  const row = {
    Title: title || "Untitled",
    Date: date || new Date().toISOString().split("T")[0],
    Time: time || new Date().toLocaleTimeString(),
    Latitude: lat || "Unavailable",
    Longitude: lon || "Unavailable",
    Area_Name: area || "Unavailable",
    Weather_Temp: weather.temp,
    Weather_Condition: weather.condition,
    Tide_Station_ID_Used: "9439040",
    Tide_Stage: "Unavailable", // You can integrate tide logic later
    Moon_Phase: "Unavailable", // Placeholder for moon API
    Barometric_Current: barometric.current,
    Barometric_6hrs_Ago: barometric.sixHoursAgo,
    Barometric_Pressure_Trend: barometric.trend
  };

  // ✅ Save to Excel
  const ws = XLSX.utils.json_to_sheet([row]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Trips");
  XLSX.writeFile(wb, "FishingTripLog.xlsx");

  console.log("Trip logged successfully:", row);
}
</script>
</body>
</html>
