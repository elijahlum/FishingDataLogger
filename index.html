<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fishing Trip Logger</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  input, button { padding: 10px; margin: 5px; }
  button { background: #007bff; color: #fff; border: none; cursor: pointer; }
  button:hover { background: #0056b3; }
</style>
</head>
<body>
<h1>Fishing Trip Logger</h1>
<input type="text" id="title" placeholder="Title">
<input type="datetime-local" id="datetime">
<input type="text" id="latitude" placeholder="Latitude">
<input type="text" id="longitude" placeholder="Longitude">
<button onclick="logTrip()">Log Trip</button>

<script>
const openWeatherApiKey = "YOUR_OPENWEATHER_API_KEY";

// Fetch weather data with error handling
async function fetchWeather(lat, lon) {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${openWeatherApiKey}&units=imperial`;
        const response = await fetch(url);
        const data = await response.json();

        if (data && data.main && data.main.temp && data.weather && data.weather[0]) {
            return {
                temp: `${data.main.temp.toFixed(2)} Â°F`,
                condition: data.weather[0].description
            };
        } else {
            console.warn("Weather API response missing fields:", data);
            return { temp: "Unavailable", condition: "Unavailable" };
        }
    } catch (error) {
        console.error("Weather fetch failed:", error);
        return { temp: "Unavailable", condition: "Unavailable" };
    }
}

// Fetch NOAA barometric pressure with fallback
async function fetchBarometricPressure(lat, lon) {
    try {
        const now = new Date();
        const endTime = now.toISOString();
        const startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000).toISOString();

        // NOAA API endpoint
        const noaaUrl = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=air_pressure&application=FishingLogger&begin_date=${startTime}&end_date=${endTime}&datum=MSL&station=9439040&time_zone=gmt&units=metric&format=json`;

        const response = await fetch(noaaUrl);
        const data = await response.json();

        if (data && data.data && data.data.length > 0) {
            const current = parseFloat(data.data[data.data.length - 1].v);
            const past = parseFloat(data.data[0].v);
            const trend = current > past ? "Rising" : current < past ? "Falling" : "Steady";
            return {
                current: `${current} hPa`,
                past: `${past} hPa`,
                trend: trend
            };
        } else {
            console.warn("NOAA response empty, using fallback.");
            return await fetchBarometricFallback(lat, lon);
        }
    } catch (error) {
        console.error("NOAA pressure fetch failed:", error);
        return await fetchBarometricFallback(lat, lon);
    }
}

// Fallback: Use OpenWeather pressure
async function fetchBarometricFallback(lat, lon) {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${openWeatherApiKey}&units=metric`;
        const response = await fetch(url);
        const data = await response.json();

        if (data && data.main && data.main.pressure) {
            const pressure = `${data.main.pressure} hPa`;
            return { current: pressure, past: "Unavailable", trend: "Unavailable" };
        } else {
            return { current: "Unavailable", past: "Unavailable", trend: "Unavailable" };
        }
    } catch (error) {
        console.error("Fallback pressure fetch failed:", error);
        return { current: "Unavailable", past: "Unavailable", trend: "Unavailable" };
    }
}

// Main logging function
async function logTrip() {
    const title = document.getElementById("title").value || "Untitled Trip";
    const datetime = document.getElementById("datetime").value;
    const lat = document.getElementById("latitude").value;
    const lon = document.getElementById("longitude").value;

    if (!datetime || !lat || !lon) {
        alert("Please enter date/time, latitude, and longitude.");
        return;
    }

    try {
        const weather = await fetchWeather(lat, lon);
        const barometric = await fetchBarometricPressure(lat, lon);

        const row = {
            Title: title,
            Date: datetime.split("T")[0],
            Time: datetime.split("T")[1],
            Latitude: lat,
            Longitude: lon,
            Area_Name: "Unavailable",
            Weather_Temp: weather.temp,
            Weather_Condition: weather.condition,
            Tide_Station_ID_Used: "9439040",
            Tide_Stage: "Unavailable",
            Moon_Phase: "Unavailable",
            Barometric_Current: barometric.current,
            Barometric_6hrs_Ago: barometric.past,
            Barometric_Pressure_Trend: barometric.trend
        };

        console.log("Logging trip:", row);

        // Save to Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet([row]);
        XLSX.utils.book_append_sheet(wb, ws, "Trips");
        XLSX.writeFile(wb, `FishingTrip_${Date.now()}.xlsx`);

        alert("Trip logged successfully!");
    } catch (error) {
        console.error("Error logging trip:", error);
        alert("Something went wrong. Check console for details.");
    }
}
</script>
</body>
</html>
