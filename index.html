// Fishing Trip Logger - Prescott Beach Version with Moon, Tide, Weather, Barometric Pressure, and Excel Logging

const locationOptions = {
  "Prescott Beach": {
    name: "Prescott Beach",
    coords: { lat: 46.1, lon: -122.9 },
    stationId: "9440422" // NOAA tide station - Longview, WA
  }
};

const OPENWEATHER_API_KEY = "cc3586d4c42cc1e784e39c79dd5fff72";

const locationSelect = document.createElement("select");
locationSelect.id = "locationSelect";

Object.keys(locationOptions).forEach(loc => {
  const option = document.createElement("option");
  option.value = loc;
  option.textContent = loc;
  locationSelect.appendChild(option);
});

document.body.appendChild(locationSelect);

const logButton = document.createElement("button");
logButton.textContent = "Log Catch";
logButton.onclick = logCatch;
document.body.appendChild(logButton);

async function logCatch() {
  const locationName = locationSelect.value;
  const { coords, stationId } = locationOptions[locationName];
  const { lat, lon } = coords;

  const now = new Date();
  const dateStr = now.toISOString().slice(0, 10);
  const timeStr = now.toTimeString().slice(0, 5);
  const beginDate = `${dateStr.replace(/-/g, '')}0000`;
  const endDate = `${dateStr.replace(/-/g, '')}2359`;

  const tideUrl = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?station=${stationId}&product=predictions&datum=MLLW&units=english&time_zone=lst_ldt&format=json&interval=60&begin_date=${beginDate}&end_date=${endDate}`;
  const moonUrl = `https://api.farmsense.net/v1/moonphases/?d=${Math.floor(now.getTime() / 1000)}`;
  const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature,precipitation,windspeed`;
  const pressureCurrentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric`;
  const pressureHistoryUrl = `https://api.openweathermap.org/data/2.5/onecall/timemachine?lat=${lat}&lon=${lon}&dt=${Math.floor((now.getTime() - 6 * 3600 * 1000) / 1000)}&appid=${OPENWEATHER_API_KEY}&units=metric`;

  try {
    const [tideRes, moonRes, weatherRes, pressureNowRes, pressurePastRes] = await Promise.all([
      fetch(tideUrl),
      fetch(moonUrl),
      fetch(weatherUrl),
      fetch(pressureCurrentUrl),
      fetch(pressureHistoryUrl)
    ]);

    const tideData = await tideRes.json();
    const moonData = await moonRes.json();
    const weatherData = await weatherRes.json();
    const pressureNowData = await pressureNowRes.json();
    const pressurePastData = await pressurePastRes.json();

    const tideNow = tideData.predictions.find(p => {
      const tideTime = new Date(`${p.t.replace(' ', 'T')}:00`);
      return Math.abs(tideTime - now) < 60 * 60 * 1000;
    });

    const currentPressure = pressureNowData.main?.pressure;
    const pastPressure = pressurePastData.current?.pressure;
    let pressureTrend = "No data";
    let pressureDiff = 0;

    if (currentPressure && pastPressure) {
      pressureDiff = currentPressure - pastPressure;
      if (pressureDiff > 1) pressureTrend = `Rising (+${pressureDiff.toFixed(1)} hPa)`;
      else if (pressureDiff < -1) pressureTrend = `Falling (${pressureDiff.toFixed(1)} hPa)`;
      else pressureTrend = "Stable";
    }

    const entry = {
      date: dateStr,
      time: timeStr,
      location: locationName,
      lat,
      lon,
      tide: tideNow ? `${tideNow.v} ft` : 'No tide data',
      moon: moonData[0] ? moonData[0].Phase : 'No moon data',
      weather: weatherData.current ? `${weatherData.current.temperature}Â°C, Wind: ${weatherData.current.windspeed} km/h` : 'No weather data',
      pressure: currentPressure ? `${currentPressure} hPa (${pressureTrend})` : 'No pressure data'
    };

    addToExcel(entry);
    console.log("Catch Logged:", entry);
    alert(`Logged: ${JSON.stringify(entry, null, 2)}`);
  } catch (err) {
    console.error("Error fetching data:", err);
    alert("Failed to fetch one or more data sources");
  }
}

function addToExcel(entry) {
  const row = [
    entry.date,
    entry.time,
    `${entry.lat}, ${entry.lon}`,
    entry.location,
    entry.tide,
    entry.moon,
    entry.weather,
    entry.pressure
  ];

  const ws = XLSX.utils.aoa_to_sheet([row]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Catch Log");

  XLSX.writeFile(wb, `FishingLog_${entry.date}.xlsx`);
}

// Load SheetJS
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
document.head.appendChild(script);
